# Authentik blueprint — FuzzyPeanut initial setup
# Applies on first boot to configure the shell OIDC application,
# branding, and default groups.
#
# Mounted into the Authentik container at blueprints/custom/fuzzypeanut.yaml
# via the docker-compose volumes config. Applied automatically on startup.
# Idempotent — safe to re-apply.
#
# Requires: Authentik 2024.4+ (redirect_uris list-of-objects format)

version: 1
metadata:
  name: FuzzyPeanut Setup
  labels:
    blueprints.goauthentik.io/description: "FuzzyPeanut initial configuration"

entries:
  # ── Default groups ────────────────────────────────────────────────────────────

  - model: authentik_core.group
    identifiers:
      name: fuzzypeanut-users
    attrs:
      name: fuzzypeanut-users

  - model: authentik_core.group
    identifiers:
      name: fuzzypeanut-admins
    attrs:
      name: fuzzypeanut-admins

  # ── Groups scope mapping ──────────────────────────────────────────────────────
  # Adds a 'groups' claim to the OIDC token containing the user's group names.
  # Used by modules for access control via sdk.auth.getUser().groups.

  - model: authentik_providers_oauth2.scopemapping
    identifiers:
      name: FuzzyPeanut Groups Scope
    attrs:
      name: FuzzyPeanut Groups Scope
      scope_name: groups
      description: "Group membership for FuzzyPeanut module access control"
      expression: |
        return list(request.user.ak_groups.values_list("name", flat=True))

  # ── Shell OIDC provider ───────────────────────────────────────────────────────

  - model: authentik_providers_oauth2.oauth2provider
    identifiers:
      name: FuzzyPeanut Shell
    attrs:
      name: FuzzyPeanut Shell
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      client_type: public
      # Must match VITE_OIDC_CLIENT_ID in the shell
      client_id: fuzzypeanut-shell
      # Authentik 2024.4+ format — list of objects with url + matching_mode
      redirect_uris:
        - url: "http://localhost:5173/auth/callback"
          matching_mode: strict
        - url: "https://app.fuzzypeanut.local/auth/callback"
          matching_mode: strict
      include_claims_in_id_token: true
      sub_mode: hashed_user_id
      issuer_mode: per_provider
      access_token_validity: "hours=1"
      refresh_token_validity: "days=30"
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
      # Wire all required scopes — openid/email/profile/offline_access from Authentik
      # built-ins, plus our custom groups mapping above.
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, offline_access]]
        - !Find [authentik_providers_oauth2.scopemapping, [name, FuzzyPeanut Groups Scope]]

  # ── Application ───────────────────────────────────────────────────────────────

  - model: authentik_core.application
    identifiers:
      slug: fuzzypeanut
    attrs:
      name: FuzzyPeanut
      slug: fuzzypeanut
      provider: !Find [authentik_providers_oauth2.oauth2provider, [name, FuzzyPeanut Shell]]
      meta_launch_url: http://localhost:5173/
      policy_engine_mode: any
